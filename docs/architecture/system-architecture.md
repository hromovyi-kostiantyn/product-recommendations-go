# Архітектура системи рекомендацій

## Огляд

Система рекомендацій продуктів побудована за принципами чистої архітектури з розділенням на шари:

1. **Шар доставки (Delivery Layer)** - відповідає за обробку HTTP-запитів, перевірку вхідних даних та форматування відповідей.
2. **Сервісний шар (Service Layer)** - містить бізнес-логіку, алгоритми рекомендацій та обробку даних.
3. **Шар репозиторію (Repository Layer)** - забезпечує доступ до бази даних та абстрагує бізнес-логіку від деталей зберігання даних.

Така архітектура забезпечує:
- **Слабку зв'язність** між компонентами системи
- **Високу тестованість** кожного шару окремо
- **Гнучкість** при зміні деталей реалізації
- **Масштабованість** системи в майбутньому

## Діаграма компонентів

```
┌─────────────────────────────────────┐
│           HTTP Delivery             │
│                                     │
│  ┌─────────────┐   ┌─────────────┐  │
│  │    Auth     │   │   Product   │  │
│  │  Handlers   │   │  Handlers   │  │
│  └─────────────┘   └─────────────┘  │
│                                     │
│  ┌─────────────┐   ┌─────────────┐  │
│  │    Like     │   │    Order    │  │
│  │  Handlers   │   │  Handlers   │  │
│  └─────────────┘   └─────────────┘  │
│                                     │
│  ┌─────────────────────────────┐    │
│  │     Recommendation          │    │
│  │        Handlers             │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│          Business Services          │
│                                     │
│  ┌─────────────┐   ┌─────────────┐  │
│  │    Auth     │   │   Product   │  │
│  │   Service   │   │   Service   │  │
│  └─────────────┘   └─────────────┘  │
│                                     │
│  ┌─────────────┐   ┌─────────────┐  │
│  │    Like     │   │    Order    │  │
│  │   Service   │   │   Service   │  │
│  └─────────────┘   └─────────────┘  │
│                                     │
│  ┌─────────────────────────────┐    │
│  │     Recommendation          │    │
│  │        Service              │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│          Data Repositories          │
│                                     │
│  ┌─────────────┐   ┌─────────────┐  │
│  │    User     │   │   Product   │  │
│  │ Repository  │   │ Repository  │  │
│  └─────────────┘   └─────────────┘  │
│                                     │
│  ┌─────────────┐   ┌─────────────┐  │
│  │    Like     │   │    Order    │  │
│  │ Repository  │   │ Repository  │  │
│  └─────────────┘   └─────────────┘  │
│                                     │
│  ┌─────────────────────────────┐    │
│  │     Recommendation          │    │
│  │      Repository             │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│           Database Layer            │
│                                     │
│          PostgreSQL / GORM          │
└─────────────────────────────────────┘
```

## Основні компоненти системи

### HTTP обробники (Delivery Layer)

HTTP обробники відповідають за:
- Обробку HTTP-запитів
- Валідацію вхідних даних
- Аутентифікацію та авторизацію
- Форматування відповідей
- Обробку помилок

Всі обробники реалізовані в пакеті `internal/delivery/http/handlers`.

### Сервіси (Service Layer)

Сервіси містять бізнес-логіку системи:
- Аутентифікація та управління користувачами
- Управління товарами
- Обробка замовлень
- Генерація рекомендацій

Інтерфейси сервісів визначені в `internal/service/interfaces.go`, реалізації - в окремих файлах того ж пакету.

### Репозиторії (Repository Layer)

Репозиторії відповідають за доступ до даних:
- Абстрагують доступ до бази даних
- Перетворюють дані між моделями та таблицями БД
- Забезпечують транзакційність операцій

Інтерфейси репозиторіїв визначені в `internal/repository/interfaces.go`, реалізації - в окремих файлах того ж пакету.

## Потік даних

1. HTTP-запит надходить до відповідного обробника
2. Обробник валідує дані та викликає відповідний метод сервісу
3. Сервіс виконує бізнес-логіку, викликаючи методи репозиторіїв для доступу до даних
4. Репозиторії взаємодіють з базою даних та повертають результати
5. Результати проходять через сервісний шар назад до обробника
6. Обробник форматує результати та відправляє HTTP-відповідь

## Алгоритми рекомендацій

### Колаборативна фільтрація

Колаборативна фільтрація аналізує поведінку користувачів для виявлення схожих патернів та надання рекомендацій на основі цих схожостей.

Кроки алгоритму:
1. Для кожного користувача формується вектор оцінок товарів
2. Обчислюється подібність між векторами оцінок користувачів (косинусна подібність)
3. Для цільового користувача знаходяться найбільш подібні користувачі
4. Рекомендуються товари, які подобаються подібним користувачам, але які цільовий користувач ще не оцінював

Реалізація алгоритму знаходиться в пакеті `pkg/recommendation/collaborative_filtering.go`.

### Контентна фільтрація

Контентна фільтрація аналізує характеристики товарів, які сподобались користувачу, та рекомендує товари з подібними характеристиками.

Кроки алгоритму:
1. Формується профіль користувача на основі характеристик вподобаних товарів
2. Обчислюється подібність між профілем користувача та товарами
3. Рекомендуються товари з найвищою подібністю

Реалізація алгоритму знаходиться в пакеті `pkg/recommendation/content_based_filtering.go`.

### Гібридний підхід

Система використовує гібридний підхід, комбінуючи результати різних алгоритмів рекомендацій:
1. Для користувачів з достатньою історією взаємодій використовується колаборативна фільтрація
2. Для нових користувачів або коли колаборативна фільтрація не дає достатньо результатів, використовується контентна фільтрація
3. Для доповнення результатів використовуються рекомендації на основі популярності товарів

Реалізація гібридного підходу знаходиться в `internal/service/recommendation_service.go`.

## Модель даних

### Основні сутності

- **User** - користувач системи
    - ID: унікальний ідентифікатор
    - Email: електронна адреса (унікальна)
    - Password: хеш паролю

- **Product** - товар в системі
    - ID: унікальний ідентифікатор
    - Name: назва товару
    - Description: опис товару
    - Price: ціна
    - Category: категорія
    - ImageURL: посилання на зображення

- **UserLike** - вподобання користувача
    - UserID: ідентифікатор користувача
    - ProductID: ідентифікатор товару
    - CreatedAt: дата створення вподобання

- **Order** - замовлення користувача
    - ID: унікальний ідентифікатор
    - UserID: ідентифікатор користувача
    - Status: статус замовлення
    - TotalPrice: загальна вартість
    - CreatedAt: дата створення

- **OrderItem** - товар у замовленні
    - OrderID: ідентифікатор замовлення
    - ProductID: ідентифікатор товару
    - Quantity: кількість
    - Price: ціна на момент замовлення

- **Recommendation** - рекомендація для користувача
    - UserID: ідентифікатор користувача
    - ProductID: ідентифікатор товару
    - Score: рейтинг релевантності
    - RecommendationType: тип рекомендації
    - CreatedAt: дата створення рекомендації

## Dependency Injection

Система використовує патерн Dependency Injection для зменшення зв'язків між компонентами. Контейнер залежностей знаходиться в `internal/container/container.go`.

Процес ініціалізації:
1. Створюється з'єднання з базою даних
2. Ініціалізуються репозиторії
3. Ініціалізуються сервіси, які отримують відповідні репозиторії
4. Ініціалізуються HTTP обробники, які отримують відповідні сервіси
5. Реєструються маршрути HTTP

## Аутентифікація

Система використовує JWT (JSON Web Tokens) для аутентифікації:
1. Користувач надсилає дані для входу (email та пароль)
2. Сервер перевіряє ці дані та генерує JWT, який містить ID користувача
3. Клієнт зберігає JWT та надсилає його в заголовку Authorization для кожного запиту
4. Middleware AuthMiddleware перевіряє JWT та додає ID користувача в контекст запиту

Реалізація аутентифікації знаходиться в `internal/service/auth_service.go` та `internal/delivery/http/middleware/auth_middleware.go`.